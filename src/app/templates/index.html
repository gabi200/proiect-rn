<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>YOLOv9 Traffic Sign Recognition</title>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='style.css') }}"
        />
        <!-- FontAwesome for Dashboard Icons -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        />
    </head>
    <body>
        <div class="header">
            <h1>üö¶ Traffic Sign Recognition System</h1>
        </div>

        <div class="container">
            <!-- Tabs Navigation -->
            <div class="tabs">
                <button
                    class="tab-btn active"
                    onclick="openTab(event, 'LiveTab')"
                >
                    üì∑ Live Webcam
                </button>
                <!-- New Dashboard Tab Button -->
                <button
                    class="tab-btn"
                    onclick="openTab(event, 'DashboardTab')"
                >
                    üöó Vehicle Dashboard
                </button>
                <button class="tab-btn" onclick="openTab(event, 'UploadTab')">
                    üì§ Image Upload
                </button>
                <button class="tab-btn" onclick="openTab(event, 'LogsTab')">
                    üìú System Logs
                </button>
            </div>

            <!-- Tab 1: Live Webcam -->
            <div id="LiveTab" class="tab-content" style="display: block">
                <div class="main-content">
                    <div class="video-box">
                        <img
                            src="{{ url_for('video_feed') }}"
                            alt="Video Feed"
                        />
                    </div>

                    <div class="sidebar">
                        <div class="controls">
                            <h2>Live Controls</h2>

                            <div class="control-group">
                                <label class="switch-label">
                                    <span>Inference Active</span>
                                    <label class="switch">
                                        <input
                                            type="checkbox"
                                            id="inferenceToggle"
                                            checked
                                        />
                                        <span class="slider round"></span>
                                    </label>
                                </label>
                            </div>

                            <div class="control-group">
                                <label for="confSlider"
                                    >Confidence Threshold:
                                    <span id="confValue" class="value-display"
                                        >0.70</span
                                    ></label
                                >
                                <input
                                    type="range"
                                    id="confSlider"
                                    min="0.01"
                                    max="1.0"
                                    step="0.01"
                                    value="0.7"
                                />
                            </div>

                            <!-- Snapshot Button -->
                            <div class="control-group">
                                <button
                                    class="action-btn full-width"
                                    onclick="location.href = '/snapshot'"
                                >
                                    üì∏ Save Snapshot
                                </button>
                            </div>

                            <p class="desc">
                                Adjust sensitivity to reduce false positives.
                            </p>
                        </div>

                        <div class="detection-log-box">
                            <h3>Detection Log (Live)</h3>
                            <div class="log-header">
                                <span>Time</span>
                                <span>Class</span>
                                <span>Conf</span>
                            </div>
                            <div id="detectionList" class="detection-list">
                                <!-- JS will populate this -->
                                <div class="detection-item">
                                    <span>--:--:--</span>
                                    <span>Waiting...</span>
                                    <span>---</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Vehicle Dashboard (New) -->
            <div id="DashboardTab" class="tab-content" style="display: none">
                <div class="dashboard-grid">
                    <!-- Video Feed (Smaller) -->
                    <div class="dash-video">
                        <h3>Forward Camera</h3>
                        <img src="{{ url_for('video_feed') }}" alt="Dash Cam" />
                    </div>

                    <!-- Instrument Cluster -->
                    <div class="dash-cluster">
                        <!-- Turn Signals -->
                        <div class="turn-signals">
                            <div id="leftSignal" class="blinker">
                                <i class="fas fa-arrow-left"></i>
                            </div>
                            <div id="rightSignal" class="blinker">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>

                        <!-- Speedometer Gauge -->
                        <div class="speedometer">
                            <div class="gauge-body">
                                <div class="gauge-fill"></div>
                                <div class="gauge-cover">
                                    <span id="currentSpeed">0</span>
                                    <span class="unit">km/h</span>
                                </div>
                                <div class="needle" id="speedNeedle"></div>
                            </div>
                            <div class="limit-indicator">
                                Limit: <span id="speedLimitVal">50</span>
                            </div>
                        </div>

                        <!-- Action Display -->
                        <div class="action-display">
                            <h3>Vehicle Status</h3>
                            <div id="actionText" class="action-text">
                                CRUISING
                            </div>
                        </div>

                        <!-- Detected Sign Image -->
                        <div class="sign-display">
                            <h3>Last Detected Sign</h3>
                            <div class="sign-box" id="signBox">
                                <!-- Standard Image -->
                                <img
                                    id="detectedSignImg"
                                    src=""
                                    alt="No Sign"
                                    style="display: none"
                                />
                                <!-- CSS Rendered Sign (Hidden by default) -->
                                <div
                                    id="cssSign"
                                    class="css-sign-circle"
                                    style="display: none"
                                >
                                    <span id="cssSignText" class="css-sign-text"
                                        >--</span
                                    >
                                </div>
                                <span id="signPlaceholder"
                                    >Waiting for sign...</span
                                >
                            </div>
                            <div id="signName" class="sign-name">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Image Upload -->
            <div id="UploadTab" class="tab-content" style="display: none">
                <div class="upload-container">
                    <div class="upload-controls">
                        <h2>Upload Image</h2>
                        <p>Select an image to detect traffic signs.</p>
                        <input type="file" id="imageInput" accept="image/*" />
                        <button class="action-btn" onclick="uploadImage()">
                            Analyze Image
                        </button>
                        <div id="uploadStatus" class="status-msg"></div>
                    </div>
                    <div class="upload-result">
                        <img
                            id="resultImage"
                            src=""
                            alt="Result will appear here"
                            style="display: none"
                        />
                        <div id="placeholder" class="placeholder-box">
                            <span>No image uploaded</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: System Logs -->
            <div id="LogsTab" class="tab-content" style="display: none">
                <div class="logs-container">
                    <div class="logs-header-row">
                        <h2>System Log File (app_activity.log)</h2>
                        <!-- Download Logs Button -->
                        <button
                            class="action-btn small-btn"
                            onclick="location.href = '/download_logs'"
                        >
                            ‚¨áÔ∏è Download Logs
                        </button>
                    </div>

                    <div class="log-actions">
                        <span class="status-dot"></span>
                        <span id="logStatus">Live Updating...</span>
                    </div>
                    <pre id="systemLogViewer" class="system-log-viewer">
Loading logs...</pre
                    >
                </div>
            </div>

            <!-- Statistics Section (Common) -->
            <div class="stats-box">
                <h2>Dataset Distribution Analysis</h2>
                <img
                    src="{{ url_for('dataset_stats_img') }}"
                    alt="Dataset Statistics"
                    class="stats-img"
                />
            </div>
        </div>

        <script>
            // Tab Switching Logic
            function openTab(evt, tabName) {
                var i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tab-content");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                tablinks = document.getElementsByClassName("tab-btn");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(
                        " active",
                        "",
                    );
                }
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.className += " active";
            }

            // --- DASHBOARD LOGIC ---
            function updateDashboard() {
                if (
                    document.getElementById("DashboardTab").style.display ===
                    "none"
                )
                    return;

                fetch("/get_vehicle_state")
                    .then((response) => response.json())
                    .then((data) => {
                        // Update Speedometer
                        document.getElementById("currentSpeed").innerText =
                            data.current_speed;
                        document.getElementById("speedLimitVal").innerText =
                            data.speed_limit;

                        // Rotate Needle (0km/h = -90deg, 180km/h = 90deg)
                        let rotation = (data.current_speed / 180) * 180 - 90;
                        document.getElementById("speedNeedle").style.transform =
                            `translateX(-50%) rotate(${rotation}deg)`;

                        // Update Action Text
                        const actText = document.getElementById("actionText");
                        actText.innerText = data.action;
                        if (data.action.includes("BRAKE"))
                            actText.style.color = "red";
                        else if (data.action.includes("CAUTION"))
                            actText.style.color = "orange";
                        else actText.style.color = "#00ffcc";

                        // Update Blinkers
                        const l = document.getElementById("leftSignal");
                        const r = document.getElementById("rightSignal");
                        l.className =
                            "blinker" +
                            (data.turn_signal === "left" ? " active" : "");
                        r.className =
                            "blinker" +
                            (data.turn_signal === "right" ? " active" : "");

                        // --- SIGN DISPLAY LOGIC ---
                        const signImg =
                            document.getElementById("detectedSignImg");
                        const cssSign = document.getElementById("cssSign");
                        const cssText = document.getElementById("cssSignText");
                        const signName = document.getElementById("signName");
                        const place =
                            document.getElementById("signPlaceholder");

                        if (data.last_sign_class) {
                            place.style.display = "none";
                            signName.innerText = data.last_sign_class;

                            // Check for Speed or Weight Limit (CSS Render)
                            let isCssSign = false;
                            let displayText = "";

                            if (
                                data.last_sign_class.includes("forb_speed_over")
                            ) {
                                isCssSign = true;
                                displayText = data.last_sign_class
                                    .split("_")
                                    .pop(); // Get '30', '50', etc.
                            } else if (
                                data.last_sign_class.includes(
                                    "forb_weight_over",
                                )
                            ) {
                                isCssSign = true;
                                displayText = data.last_sign_class
                                    .split("_")
                                    .pop(); // Get '3.5t'
                            }

                            if (isCssSign) {
                                // Show CSS Sign
                                signImg.style.display = "none";
                                cssSign.style.display = "flex";
                                cssText.innerText = displayText;

                                // Adjust font size for longer text (e.g. 3.5t or 100)
                                cssText.className = "css-sign-text"; // Reset
                                if (displayText.length >= 3) {
                                    cssText.classList.add(
                                        displayText.includes("t")
                                            ? "long-text"
                                            : "three-digits",
                                    );
                                }
                            } else {
                                // Show Image from Folder
                                cssSign.style.display = "none";
                                signImg.src =
                                    "/static/signs/" +
                                    data.last_sign_class +
                                    ".png";
                                signImg.style.display = "block";
                            }
                        }
                    });
            }
            setInterval(updateDashboard, 500); // Update every 500ms

            // Live Controls Logic
            const slider = document.getElementById("confSlider");
            const display = document.getElementById("confValue");
            const toggle = document.getElementById("inferenceToggle");

            function updateSettings() {
                fetch("/update_settings", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        conf: parseFloat(slider.value),
                        inference_enabled: toggle.checked,
                    }),
                });
            }

            slider.oninput = function () {
                display.innerHTML = this.value;
                updateSettings();
            };

            toggle.onchange = function () {
                updateSettings();
            };

            // Image Upload Logic
            function uploadImage() {
                const input = document.getElementById("imageInput");
                const status = document.getElementById("uploadStatus");
                const resultImg = document.getElementById("resultImage");
                const placeholder = document.getElementById("placeholder");

                if (input.files.length === 0) {
                    status.innerHTML = "Please select a file first.";
                    status.style.color = "orange";
                    return;
                }

                const formData = new FormData();
                formData.append("file", input.files[0]);

                status.innerHTML = "Processing...";
                status.style.color = "#00ffcc";

                fetch("/upload_image", {
                    method: "POST",
                    body: formData,
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.status === "success") {
                            resultImg.src =
                                "data:image/jpeg;base64," + data.image;
                            resultImg.style.display = "block";
                            placeholder.style.display = "none";
                            status.innerHTML = "Done!";
                        } else {
                            status.innerHTML = "Error: " + data.error;
                            status.style.color = "red";
                        }
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                        status.innerHTML = "Upload failed.";
                        status.style.color = "red";
                    });
            }

            // Live Detection Log Polling
            function fetchDetections() {
                // Only poll if Live Tab is active
                if (document.getElementById("LiveTab").style.display === "none")
                    return;

                fetch("/get_detections")
                    .then((response) => response.json())
                    .then((data) => {
                        const list = document.getElementById("detectionList");
                        list.innerHTML = "";
                        data.forEach((item) => {
                            const div = document.createElement("div");
                            div.className = "detection-item";
                            div.innerHTML = `<span>${item.time}</span><span class="det-class">${item.class}</span><span>${item.conf}</span>`;
                            list.appendChild(div);
                        });
                    });
            }
            setInterval(fetchDetections, 1000);

            // System Log Polling
            function fetchSystemLog() {
                // Only poll if Logs Tab is active
                if (document.getElementById("LogsTab").style.display === "none")
                    return;

                fetch("/get_app_log")
                    .then((response) => response.json())
                    .then((data) => {
                        const viewer =
                            document.getElementById("systemLogViewer");
                        // Check if scrolled to bottom before updating to keep auto-scroll
                        const isScrolledToBottom =
                            viewer.scrollHeight - viewer.clientHeight <=
                            viewer.scrollTop + 1;

                        viewer.textContent = data.content;

                        if (isScrolledToBottom) {
                            viewer.scrollTop = viewer.scrollHeight;
                        }
                    });
            }
            setInterval(fetchSystemLog, 2000);
        </script>
    </body>
</html>
